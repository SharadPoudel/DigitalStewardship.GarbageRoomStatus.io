<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>MQTT Subscriber for Sensor Data</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.2/mqttws31.min.js"></script>
    <script type="module">
      // Firestore stuff
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js';
      import { getFirestore, collection, getDocs, addDoc, query, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js';

      const firebaseConfig = {
        // Firebase configuration
        
            apiKey: "AIzaSyDZFmGewFYpK6aDnfjVltwK8bHE5x6___o",
            authDomain: "digitalstewardship.firebaseapp.com",
            projectId: "digitalstewardship",
            storageBucket: "digitalstewardship.appspot.com",
            messagingSenderId: "469552118705",
            appId: "1:469552118705:web:98fa6c5262ac8258d79b90"
        
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      async function addPost(sensorID, message) {
        const timestamp = Date.now();
        await addDoc(collection(db, 'sensordata'), {
          sensorid: sensorID,
          message: message,
          timestamp: timestamp
        });
      }

      // Connect to the MQTT broker
      const client = new Paho.MQTT.Client("localhost", Number(8084), "html_subscriber");

      // Set callback handlers
      client.onConnectionLost = onConnectionLost;
      client.onMessageArrived = onMessageArrived;

      // Connect the client
      client.connect({ onSuccess: onConnect });

      // Called when the client connects
      function onConnect() {
        console.log("Connected to MQTT broker");
        client.subscribe("sensor1");
        client.subscribe("sensor2");
        client.subscribe("sensor3");
        client.subscribe("sensor4");
        client.subscribe("sensor5");
        client.subscribe("sensor6");
        client.subscribe("sensor7");
        client.subscribe("sensor8");
        client.subscribe("sensor9");
        client.subscribe("sensor10");
        client.subscribe("sensor11");
      }

      // Called when the client loses its connection
      function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
          console.log("Connection lost: " + responseObject.errorMessage);
        }
      }

      // Called when a message arrives
      function onMessageArrived(message) {
        const topic = message.destinationName;
        const payload = message.payloadString;

        console.log("Message received: Topic = " + topic + ", Payload = " + payload);

        addPost(topic, payload);
      }
      window.addPost = addPost;
    </script>
  </head>

  <body>
    <h1>MQTT Subscriber for Sensor Data</h1>
    <div id="data"></div>
  </body>
</html>
