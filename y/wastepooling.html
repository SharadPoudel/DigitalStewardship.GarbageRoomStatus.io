<!DOCTYPE html>
<html>


<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Digital Stewardship</title>
    <link rel="stylesheet" href="styles.css" />
    <link href="https://fonts.googleapis.com/css2?family=Kumbh+Sans:wght@400;700&display=swap" rel="stylesheet" />


    <script type='module' src='./firebase_config.js'></script>
    <style>
        .item-name-label {
            font-size: 16px;
        }

        .item-address-label {
            font-size: 12px;
        }

        label {
            display: block;
            overflow-wrap: break-word;
            text-align: left;
        }

        .post-image-label {
            width: fit-content;
        }


        .image-capture {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }

        .post-template-div {
            inline-size: min-content;
            border-style: solid;
            padding: 10px;
            display: inline-block;
            box-sizing: border-box;
            margin: 10px;

        }

        .delete-label {

            width: fit-content;
        }

        .contact-label {

            width: fit-content;
        }

        .save-label {

            width: fit-content;
        }

        .save-div {
            border-style: solid;
            padding: 3px;
            display: inline-block;
            width: fit-content;
        }

        .delete-div {
            border-color: #E5EFE5;
            background-color: #F9FCFA;
            border-radius: 5px;;
            border-style: solid;
            font-size: 1rem;
            font-weight: 450;
            color: #4D8D6E;
            display: inline-block;
            width: fit-content;
            margin-right: 1em;
        }

        .delete-div:active { 
            background-color: #c5c5c5;
        }

        .contact-div {
            border-color: #E5EFE5;
            background-color: #F9FCFA;
            border-radius: 5px;;
            border-style: solid;
            font-size: 1rem;
            font-weight: 450;
            color: #4D8D6E;
            display: inline-block;
            width: fit-content;
        }
        
        .contact-div:active { 
            background-color: #c5c5c5;
        }

        .form-inputs-div {
            padding-left: 1.2em;
            padding-bottom: 1.2em;
        }

        .add-info-p {
            font-size: 12px;
            color: #F4F9F6;
        }
    </style>
</head>

<body>
    <!-- Navbar Section -->
    <nav class="navbar">
        <div class="navbar_container">
          <img id="logo" class="logo" src="images/logo.svg" width="20%"/>
          <div class="navbar_toggle" id="mobile-menu">
            <span class="bar"></span> <span class="bar"></span>
            <span class="bar"></span>
          </div>
          <ul class="navbar_menu">
            <li class="navbar_item">
              <a href="/status_page.html" class="navbar_links">Status</a>
            </li>
            <li class="navbar_item">
              <a href="/wastepooling.html" class="navbar_links">WastePooling</a>
            </li>
          </ul>
        </div>
      </nav>
    <div class="main">
        <div class="main_container">
            <div class="main_content">
                <h1>Wastepooling</h1>
                <p class="intro-p">Här kan du begära upphämtning av grovt avfall eller kontakta personer för att erbjuda upphämtning i Granngården, Beckomberga. </p>

                <form id="post-form" class="post-form">
                    <label class="top-container-div">
                        <h2 id="form-heading">Har du något grovt avfall som behöver hämtas?</h2>
                        <div class="form-container">
                            <div>
                                <label for="item-name-input">Namn på artikeln</label>
                                <input id="item-name-input" class="item-name-input" required>
                            </div>

                            <div>
                                <label for="personal-name-input">Ditt namn</label>
                                <input id="personal-name-input" class="item-name-input">
                            </div>

                            <div>
                                <label for="address-input">Adress</label>
                                <input id="address-input" class="item-name-input">
                            </div>

                            <div>
                                <label for="email-input">E-post</label>
                                <input id="email-input" class="item-name-input">
                            </div>

                            <div>
                                <label for="moreinfo-input">Ytterligare information</label>
                                <input id="moreinfo-input" class="item-name-input">
                            </div>

                        </div>
                        <div class="addimage_savepost_container">
                            <label class="addimage_button">
                              <img src="../images/addimage.svg" id="image-container">
                              <input type="file" class="image-capture" accept="image/*" id="file-input" onchange="sendImage()">
                            </label>
                            <input type="button" class="button-div" onclick="savePost()" value="Publicera">
                          </div>
                          
                    </label>
                </form>
                <div id="post-container-div" class="post-container-div" onload="getPosts()"></div>
            </div>
        </div>
    </div>


    <script type="module">

        // Imports the neccesary resources from firestore abd firebase storage
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js';
        import { getFirestore, collection, getDocs, addDoc, query, setDoc, doc, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-storage.js"

        // setting up the firebase to our project id
        const firebaseConfig = {
            apiKey: "AIzaSyDZFmGewFYpK6aDnfjVltwK8bHE5x6___o",
            authDomain: "digitalstewardship.firebaseapp.com",
            projectId: "digitalstewardship",
            storageBucket: "digitalstewardship.appspot.com",
            messagingSenderId: "469552118705",
            appId: "1:469552118705:web:98fa6c5262ac8258d79b90"
        };

        // Initializing variables that has to be global since they are accessed from multiple functions
        var postImageInput, itemName, address, email, postImagePreview, photo, postItem, postAddress, postEmail, postCompleted, addInfo, postAddInfo;

        // Creates an object for completed posts where we can store the posts' ids and the corresponding post
        var completedPosts = {};

        // Creates an array for input files for getting user inputted files
        var files = [];

        // Initializing a filereader to parse the image file that comes in
        var reader = new FileReader();

        // Assigning HTML elements to javascript variables so that we can access our page from the script
        itemName = document.getElementById('item-name-input');
        address = document.getElementById('address-input');
        email = document.getElementById('email-input');
        postImageInput = document.getElementById('file-input');
        addInfo = document.getElementById('moreinfo-input')
        postImagePreview = document.getElementById('image-container');

        // Initializing firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage();

        // FUNCTIONS //         // FUNCTIONS //         // FUNCTIONS //         // FUNCTIONS //         // FUNCTIONS //          // FUNCTIONS // 

        // get all posts function. Queries the database for all entries and for each entry it creates a div that contains an item container with data, 
        // an item container with data, an address container with data. It displays each div in a content area with its corresponding data and returns a list of the divs that were created
        async function getPosts() {

            var postList;




            const q = query(collection(db, "digitalstewardship"));

            const querySnapshot = await getDocs(q);
            querySnapshot.forEach((doc) => {

                var i = 0;

                postList = querySnapshot.docs.map(doc => doc.data());

                postCompleted = document.createElement('div');
                postCompleted.setAttribute('class', 'post-completed-div');
                postCompleted.setAttribute('id', 'post-completed-div');

                let image = document.createElement('img');
                image = new Image(160, 160);
                image.src = doc.data().image;

                let item = document.createElement('label');
                item.setAttribute('class', 'item-name-label');
                item.innerHTML = doc.data().itemname;
                

                let postAddress = document.createElement('label');
                postAddress.setAttribute('class', 'item-address-label');

                if(doc.data().address == null) {
                    postAddress.innerHTML = '';
                } else {
                    postAddress.innerHTML = doc.data().address;
                }

                let addInfo = document.createElement('p');
                addInfo.setAttribute('class', 'add-info-p');

                if(doc.data().addinfo == null) {
                    addInfo.innerHTML = '';
                } else {
                    addInfo.innerHTML = doc.data().addinfo;
                }

                let postDelete = document.createElement('div');
                postDelete.setAttribute('class', 'delete-div');

                let postDeleteLabel = document.createElement('label');
                postDeleteLabel.innerHTML = 'Radera';
                postDeleteLabel.setAttribute('class', 'delete-label');
                postDeleteLabel.setAttribute('id', 'post-delete-button');

                let postContact = document.createElement('div');
                postContact.setAttribute('class', 'contact-div');

                let postContactLabel = document.createElement('label');
                postContactLabel.innerHTML = 'Kontakta';
                postContactLabel.setAttribute('class', 'contact-label');
                postContactLabel.setAttribute('id', 'post-contact-button');

                postDelete.appendChild(postDeleteLabel);

                postContact.appendChild(postContactLabel);

                postCompleted.appendChild(image);
                postCompleted.appendChild(item);
                postCompleted.appendChild(postAddress);
                postCompleted.appendChild(addInfo);
                postCompleted.appendChild(postDelete);
                postCompleted.appendChild(postContact);

                document.getElementById('post-container-div').appendChild(postCompleted);

                completedPosts = {
                    ...completedPosts,
                    [postCompleted.childNodes[i].src]: postCompleted
                };

                var postid = postCompleted.childNodes[i].src;


                i++


                postContactLabel.onclick = function () { contactPeer(postid) };

                postDeleteLabel.onclick = function () { deletePost(postid) };



            });

            return postList;

        }
        var list = getPosts();

        async function addPost(i, a, e, img, info) {
            const add = await addDoc(collection(db, 'digitalstewardship'), {
                itemname: i,
                address: a,
                email: e,
                image: img,
                timestamp: Date.now(),
                addinfo: info
            });
            window.location.reload();
        }

        // send the image url as id.
        async function deletePost(postid) {

            const q = query(collection(db, "digitalstewardship"));
            const querySnapshot = await getDocs(q);

            querySnapshot.forEach(async (document) => {

                if (postid == document.data().image) {
                    console.log("wuf", postid);

                    await deleteDoc(doc(db, 'digitalstewardship', document.id)).then(() => {
                        window.location.reload();
                    }).catch((error) => {

                    });

                    const imgRef = ref(storage, postid);

                    await deleteObject(imgRef).then(() => {

                        // File deleted successfully
                    }).catch((error) => {
                        // Uh-oh, an error occurred!
                    });
                }
            })
        }


        async function getPostId() {
            const q = query(collection(db, "digitalstewardship"));

            const querySnapshot = await getDocs(q);
            console.log(querySnapshot.document);

            return querySnapshot.document;

        }

        let imagePreviewRef = ref(storage, 'image_preview.png');

        getDownloadURL(imagePreviewRef)
            .then((url) => {

                postImagePreview.src = url;
            })
            .catch((error) => {

                switch (error.code) {
                    case 'storage/object-not-found':
                        break;
                    case 'storage/unauthorized':
                        break;
                    case 'storage/canceled':
                        break;
                    case 'storage/unknown':
                        break;
                }
            });

        const sendImage = () => {
            var postImageInput = document.getElementById('file-input');
            files = postImageInput.files;
            photo = files[0];

            console.log(files[0]);

            // var item = getImageName();
            reader.readAsDataURL(photo);
        }

        reader.onload = function () {
            postImagePreview.src = reader.result;
        }


        window.sendImage = sendImage;


        const savePost = () => {

            if (photo) {

                postItem = document.createElement('label');
                postItem.innerHTML = itemName.value;

                postEmail = document.createElement('label');
                postEmail.innerHTML = email.value;

                postAddInfo = document.createElement('p');
                postAddInfo.innerHTML = addInfo.value;

                const stream = new MediaStream();
                let image = document.createElement('img');
                image.srcObject = stream;
                image.src = "../images/image_preview.png";
                image.src = window.URL.createObjectURL(photo);

                postAddress = document.createElement('label');
                postAddress.innerHTML = address.value;

                uploadImage(photo);

                // document.getElementById('post-container-div').appendChild(postCompleted);
                document.getElementById('post-form').reset();

                getDownloadURL(imagePreviewRef)
                    .then((url) => {

                        document.getElementById('image-container').src = url;
                    })
                    .catch((error) => {

                        switch (error.code) {
                            case 'storage/object-not-found':
                                break;
                            case 'storage/unauthorized':
                                break;
                            case 'storage/canceled':
                                break;
                            case 'storage/unknown':
                                break;
                        }
                    });
            }

        }

        window.savePost = savePost;

        async function compressImage(image) {

            console.log(image);
            // Create a canvas and draw the image to it
            var canvas = document.createElement('canvas');
            var ctx = canvas.getContext('2d');
            canvas.width = image.naturalWidth;
            canvas.height = image.naturalHeight;
            ctx.drawImage(image, 0, 0);
            // Compress the image using canvas.toDataURL()
            var dataUrl = canvas.toDataURL('image/jpeg', 0.5);
            // Convert the data URL to a Blob
            var blob = await fetch(dataUrl).then(r => r.blob());
            // Return the compressed image as a Blob
            return blob;
        }

        async function uploadImage(image) {
            // var blob = await compressImage(image);
            var filename = Math.floor(Date.now() / 1000) + '-' + image.name;
            var storageRef = ref(storage, filename);

            var downloadURL;

            uploadBytes(storageRef, image).then((snapshot) => {
                console.log('Uploaded a blob or file!');
                getDownloadURL(snapshot.ref).then((downloadURL) => {
                    // console.log('File available at', downloadURL);
                    saveUrl(downloadURL, filename);
                });

            });
        }

        function saveUrl(url, filename) {

            var image = url;
            var item = postItem.innerHTML;
            var addr = postAddress.innerHTML;
            var email = postEmail.innerHTML;
            var addInfo = postAddInfo.innerHTML;

            console.log("Inserted data into Firestore: " + item + ", " + addr + ", " + email + ", " + addInfo + ", " + image);

            addPost(item, addr, email, image, addInfo);

            return url;
        }

        async function contactPeer(postid) {

            var userEmail;

            const q = query(collection(db, "digitalstewardship"));

            const querySnapshot = await getDocs(q);

            querySnapshot.forEach((document) => {

                if (postid == document.data().image) {

                    userEmail = document.data().email;

                    window.location.href = "mailto:" + userEmail + "?subject=" + document.data().itemname;
                }
            })
        }

    </script>

<script type="module" src="app.js"></script>
</body>

</html>