<!DOCTYPE html>
<html>


<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Digital Stewardship</title>
    <link rel="stylesheet" href="styles.css" />
    <link href="https://fonts.googleapis.com/css2?family=Kumbh+Sans:wght@400;700&display=swap" rel="stylesheet" />


    <script type='module' src='./firebase_config.js'></script>
    <style>
        .item-name-label {
            font-size: 16px;
        }

        .item-address-label {
            font-size: 12px;
        }
        label {
            display: block;
            overflow-wrap: break-word;
            text-align: left;
        }

        .image-container {
            width: fit-content;
            padding: 10px;

        }

        .post-image-label {
            width: fit-content;
        }


        .image-capture {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }

        .post-template-div {
            inline-size: min-content;
            border-style: solid;
            padding: 10px;
            display: inline-block;
            box-sizing: border-box;
            margin: 10px;

        }

        .intro-p {
            margin: 10px;
        }



        .top-container-div {
            padding: 10px;
            margin: 10px;
            display: inline-block;
            text-align: center;
        }

        .post-completed-div {
            inline-size: min-content;
            background-color: #4D8D6E;

            padding: 10px;
            box-sizing: border-box;
            display: inline-block;
            margin: 10px;
            vertical-align: top;
        }

        .button-div {
            width: 20em;
            text-align: center;
            border-color: #E5EFE5;
            color: #E5EFE5;
        }

        .delete-label {

            width: fit-content;
        }

        .contact-label {

            width: fit-content;
        }

        .save-label {

            width: fit-content;
        }

        .save-div {
            border-style: solid;
            padding: 3px;
            display: inline-block;
            width: fit-content;
        }

        .delete-div {
            background-color: transparent;
            border-radius: 2px;
            ;
            border-style: solid;
            border-color: #E5EFE5;
            display: inline-block;
            width: fit-content;
        }

        .contact-div {
            background-color: transparent;
            border-radius: 2px;
            ;
            border-style: solid;
            border-color: #E5EFE5;
            display: inline-block;
            width: fit-content;
        }

        .top-container-div {
            display: inline-block;
        }

        .form-inputs-div {
            padding-left: 1.2em;
            padding-bottom: 1.2em;
        }
    </style>
</head>

<body>
    <!-- Navbar Section -->
    <nav class="navbar">
        <div class="navbar__container">
            <img id="logo" src="images/logo.svg" width="20%" />
            <div class="navbar__toggle" id="mobile-menu">
                <span class="bar"></span> <span class="bar"></span>
                <span class="bar"></span>
            </div>
            <ul class="navbar__menu">
                <li class="navbar_item">
                    <a href="/status_page.html" class="navbar__links">Status</a>
                </li>
                <li class="navbar_item">
                    <a href="/wastepooling.html" class="navbar__links">WastePooling</a>
                </li>
            </ul>
        </div>
    </nav>
    <div class="main">
        <div class="main_container">
            <div class="main_content">
                <h1>Wastepooling</h1>
                <p class="intro-p">On this page you can post your bulky waste in need of pickup or select a post to
                    offer pickup in
                    Granngården, Beckomberga. </p>

                <form id="post-form">
                    <div class="top-container-div">
                        <h2>Do you have any bulky waste in need of pickup?</h2>
                        <div class="form-container">
                            <div class="image-and-input-container">
                                <label for="file-input">
                                <img src="../images/image_preview.png" width="160" height="160" id="image-container">
                                <input type="file" class="image-capture" accept="image/*" id="file-input"
                                    onchange="sendImage()">
                                </label>

                            </div>

                            <div class="form-inputs-div">
                                <div>
                                    <label for="item-name-input">Namn på artikeln: </label>
                                    <input id="item-name-input">
                                </div>

                                <div>
                                    <label for="address-input">Adress: </label>
                                    <input id="address-input">
                                </div>

                                <div>
                                    <label for="email-input">E-post: </label>
                                    <input id="email-input">
                                </div>

                            </div>

                        </div>
                        <input type="button" class="button-div" onclick="savePost()" value="Post">
                    </div>
                </form>
                <div id="post-container-div" class="post-container-div" onload="getPosts()"></div>
            </div>
        </div>
    </div>


    <script type="module">

        // Imports the neccesary resources from firestore abd firebase storage
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js';
        import { getFirestore, collection, getDocs, addDoc, query, setDoc, doc, deleteDoc } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-storage.js"

        // setting up the firebase to our project id
        const firebaseConfig = {
            apiKey: "AIzaSyDZFmGewFYpK6aDnfjVltwK8bHE5x6___o",
            authDomain: "digitalstewardship.firebaseapp.com",
            projectId: "digitalstewardship",
            storageBucket: "digitalstewardship.appspot.com",
            messagingSenderId: "469552118705",
            appId: "1:469552118705:web:98fa6c5262ac8258d79b90"
        };

        // Initializing variables that has to be global since they are accessed from multiple functions
        var postImageInput, itemName, address, email, postImagePreview, photo, postItem, postAddress, postEmail, postCompleted;

        // Creates an object for completed posts where we can store the posts' ids and the corresponding post
        var completedPosts = {};

        // Creates an array for input files for getting user inputted files
        var files = [];

        // Initializing a filereader to parse the image file that comes in
        var reader = new FileReader();

        // Assigning HTML elements to javascript variables so that we can access our page from the script
        itemName = document.getElementById('item-name-input');
        address = document.getElementById('address-input');
        email = document.getElementById('email-input');
        postImageInput = document.getElementById('file-input');
        postImagePreview = document.getElementById('image-container');

        // Initializing firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage();

        // FUNCTIONS //         // FUNCTIONS //         // FUNCTIONS //         // FUNCTIONS //         // FUNCTIONS //          // FUNCTIONS // 

        // get all posts function. Queries the database for all entries and for each entry it creates a div that contains an item container with data, 
        // an item container with data, an address container with data. It displays each div in a content area with its corresponding data and returns a list of the divs that were created
        async function getPosts() {

            var postList;




            const q = query(collection(db, "digitalstewardship"));

            const querySnapshot = await getDocs(q);
            querySnapshot.forEach((doc) => {

                var i = 0;

                postList = querySnapshot.docs.map(doc => doc.data());

                postCompleted = document.createElement('div');
                postCompleted.setAttribute('class', 'post-completed-div');
                postCompleted.setAttribute('id', 'post-completed-div');

                let image = document.createElement('img');
                image = new Image(160, 160);
                image.src = doc.data().image;

                let item = document.createElement('label');
                item.setAttribute('class', 'item-name-label');
                item.innerHTML = doc.data().itemname;

                let postAddress = document.createElement('label');
                postAddress.setAttribute('class', 'item-address-label');
                postAddress.innerHTML = doc.data().address;

                let postDelete = document.createElement('div');
                postDelete.setAttribute('class', 'delete-div');

                let postDeleteLabel = document.createElement('label');
                postDeleteLabel.innerHTML = 'Delete?';
                postDeleteLabel.setAttribute('class', 'delete-label');
                postDeleteLabel.setAttribute('id', 'post-delete-button');

                let postContact = document.createElement('div');
                postContact.setAttribute('class', 'contact-div');

                let postContactLabel = document.createElement('label');
                postContactLabel.innerHTML = 'Contact';
                postContactLabel.setAttribute('class', 'contact-label');
                postContactLabel.setAttribute('id', 'post-contact-button');

                postDelete.appendChild(postDeleteLabel);

                postContact.appendChild(postContactLabel);

                postCompleted.appendChild(image);
                postCompleted.appendChild(item);
                postCompleted.appendChild(postAddress);
                postCompleted.appendChild(postDelete);
                postCompleted.appendChild(postContact);

                document.getElementById('post-container-div').appendChild(postCompleted);

                completedPosts = {
                    ...completedPosts,
                    [postCompleted.childNodes[i].src]: postCompleted
                };

                var postid = postCompleted.childNodes[i].src;

                // console.log(postid);
                i++


                postContactLabel.onclick = function () { contactPeer(postid) };

                postDeleteLabel.onclick = function () { deletePost(postid) };

                //console.log(postCompleted.src);

            });
            // console.log(completedPosts);
            return postList;

        }
        var list = getPosts();

        // console.log(completedPosts);

        async function addPost(i, a, e, img) {
            const add = await addDoc(collection(db, 'digitalstewardship'), {
                itemname: i,
                address: a,
                email: e,
                image: img
            });
            window.location.reload();
        }

        // send the image url as id.
        async function deletePost(postid) {

            //console.log(Object.keys(post));
            // console.log(postid);
            // console.log(post.childNodes[0].src);

            const q = query(collection(db, "digitalstewardship"));
            const querySnapshot = await getDocs(q);

            querySnapshot.forEach(async (document) => {

                if (postid == document.data().image) {
                    console.log("wuf", postid);

                    await deleteDoc(doc(db, 'digitalstewardship', document.id)).then(() => {
                        window.location.reload();
                    }).catch((error) => {

                    });

                    const imgRef = ref(storage, postid);

                    await deleteObject(imgRef).then(() => {

                        // File deleted successfully
                    }).catch((error) => {
                        // Uh-oh, an error occurred!
                    });
                }
            })
        }


        async function getPostId() {
            const q = query(collection(db, "digitalstewardship"));

            const querySnapshot = await getDocs(q);
            console.log(querySnapshot.document);

            return querySnapshot.document;

        }

        let imagePreviewRef = ref(storage, 'image_preview.png');

        getDownloadURL(imagePreviewRef)
            .then((url) => {

                postImagePreview.src = url;
            })
            .catch((error) => {

                switch (error.code) {
                    case 'storage/object-not-found':
                        break;
                    case 'storage/unauthorized':
                        break;
                    case 'storage/canceled':
                        break;
                    case 'storage/unknown':
                        break;
                }
            });

        const sendImage = () => {
            var postImageInput = document.getElementById('file-input');
            files = postImageInput.files;
            photo = files[0];

            console.log(files[0]);

            // var item = getImageName();
            reader.readAsDataURL(photo);
        }

        reader.onload = function () {
            postImagePreview.src = reader.result;
        }


        window.sendImage = sendImage;


        const savePost = () => {

            /*          postCompleted = document.createElement('div');
                        postCompleted.setAttribute('class', 'post-completed-div');
                        postCompleted.setAttribute('id', 'post-completed-div');
            
            
                        postItem = document.createElement('label');
                        postItem.setAttribute('class', 'item-name-label'); 
                        postItem.innerHTML = itemName.value;
            
                        postEmail = document.createElement('label');
                        postEmail.setAttribute('class', 'email-label');
                        postEmail.innerHTML = email.value;
            
                        postAddress = document.createElement('label');
                        postAddress.innerHTML = address.value;
            
                        let postDelete = document.createElement('div');
                        postDelete.setAttribute('class', 'delete-div');
            
                        let postDeleteLabel = document.createElement('label');
                        postDeleteLabel.innerHTML = 'Delete?';
                        postDeleteLabel.setAttribute('class', 'delete-label');
                        postDeleteLabel.setAttribute('id', 'post-delete-button');
                        postDeleteLabel.onclick = function () { deletePost('1fhMEJ52e0CVkPqshGdy') };
            
                        let postContact = document.createElement('div');
                        postContact.setAttribute('class', 'contact-div');
            
            
                        let postContactLabel = document.createElement('label');
                        postContactLabel.innerHTML = 'Contact';
                        postContactLabel.setAttribute('class', 'contact-label');
                        postContactLabel.setAttribute('id', 'post-contact-button');
            
            
                        postContactLabel.onclick = function () { contactPeer() };
            
                        postDelete.appendChild(postDeleteLabel);
            
                        postContact.appendChild(postContactLabel);
            
                        postCompleted.appendChild(image);
                        postCompleted.appendChild(postItem);
                        postCompleted.appendChild(postAddress);
                        postCompleted.appendChild(postDelete);
                        postCompleted.appendChild(postContact); */


            postItem = document.createElement('label');
            postItem.innerHTML = itemName.value;

            postEmail = document.createElement('label');
            postEmail.innerHTML = email.value;


            const stream = new MediaStream();
            let image = document.createElement('img');
            image.srcObject = stream;
            image.src = window.URL.createObjectURL(photo);

            postAddress = document.createElement('label');
            postAddress.innerHTML = address.value;

            uploadImage(photo);

            // document.getElementById('post-container-div').appendChild(postCompleted);
            document.getElementById('post-form').reset();

            getDownloadURL(imagePreviewRef)
                .then((url) => {

                    document.getElementById('image-container').src = url;
                })
                .catch((error) => {

                    switch (error.code) {
                        case 'storage/object-not-found':
                            break;
                        case 'storage/unauthorized':
                            break;
                        case 'storage/canceled':
                            break;
                        case 'storage/unknown':
                            break;
                    }
                });
        }

        window.savePost = savePost;

        async function compressImage(image) {

            console.log(image);
            // Create a canvas and draw the image to it
            var canvas = document.createElement('canvas');
            var ctx = canvas.getContext('2d');
            canvas.width = image.naturalWidth;
            canvas.height = image.naturalHeight;
            ctx.drawImage(image, 0, 0);
            // Compress the image using canvas.toDataURL()
            var dataUrl = canvas.toDataURL('image/jpeg', 0.5);
            // Convert the data URL to a Blob
            var blob = await fetch(dataUrl).then(r => r.blob());
            // Return the compressed image as a Blob
            return blob;
        }

        async function uploadImage(image) {
            // var blob = await compressImage(image);
            var filename = Math.floor(Date.now() / 1000) + '-' + image.name;
            var storageRef = ref(storage, filename);

            var downloadURL;

            uploadBytes(storageRef, image).then((snapshot) => {
                console.log('Uploaded a blob or file!');
                getDownloadURL(snapshot.ref).then((downloadURL) => {
                    // console.log('File available at', downloadURL);
                    saveUrl(downloadURL, filename);
                });

            });
        }

        function saveUrl(url, filename) {

            var image = url;
            var item = postItem.innerHTML;
            var addr = postAddress.innerHTML;
            var email = postEmail.innerHTML;

            console.log("Inserted data into Firestore: " + item + ", " + addr + ", " + email + ", " + image);

            addPost(item, addr, email, image);

            return url;
        }

        async function contactPeer(postid) {

            var userEmail;

            const q = query(collection(db, "digitalstewardship"));

            const querySnapshot = await getDocs(q);

            querySnapshot.forEach((document) => {

                if (postid == document.data().image) {

                    userEmail = document.data().email;

                    window.location.href = "mailto:" + userEmail + "?subject=" + document.data().itemname;
                }
            })
        }

    </script>


</body>

</html>